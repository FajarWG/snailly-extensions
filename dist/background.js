const h=async e=>{if(!self.ai||!self.ai.languageModel)return;const o=`You are an advanced AI model trained for sentiment and content analysis. Your task is to classify the overall sentiment and type of content on a website as either "Positive" or "Negative" based on the following criteria:
  
  Criteria for Classification:
  1. Positive:
  - Content promotes optimism, encouragement, positivity, or neutral and constructive topics.
  - Examples: educational content, inspirational stories, or problem-solving discussions.
  
  2. Negative:
  - Content includes disturbing, harmful, or inappropriate topics such as:
     - Violence, murder, or graphic harm.
     - Pornographic or explicit material.
     - Hate speech, bullying, or other toxic behaviors.
  - Overall tone is discouraging, alarming, or detrimental to well-being.
  
  Instructions:
  1. Analyze the text content thoroughly.
  2. Determine the overall sentiment and nature of the content.
  3. Based on the criteria above, classify the content strictly as either 'Positive' or 'Negative.'
  
  Response Format:
  Your response must be one word only: Positive or Negative.
  Input:
  "${e}"`;let t="";try{session||(await m(),updateStats());const r=await session.promptStreaming(o);for await(const n of r)t=n.trim();if(console.log("Response from AI Model:",t),t==="negative"){const n="https://www.vitejs.dev/";chrome.tabs.update(sender.tab.id,{url:n}),console.log(`Prediction: Negative. Redirected to ${n}`)}else t==="positive"?console.log("Prediction: Positive. No redirection."):console.error("Invalid response from AI Model:",t)}catch(r){console.error("Error during AI processing:",r.message)}finally{session&&(session.destroy(),console.log("Session destroyed.")),updateStats()}},m=async()=>{session=await self.ai.languageModel.create({temperature:.7,topK:40}),resetUI(),updateStats()};chrome.runtime.onInstalled.addListener(()=>{console.log("Chrome Extension is installed!"),d(),chrome.storage.onChanged.addListener((e,o)=>{o==="local"&&e.token&&d()})});const p="https://snailly.unikom.ac.id";let l;chrome.storage.local.get(["token"],e=>{l=e.token});function d(){chrome.storage.local.get(["token"],e=>{if(!e.token){console.error("You need to log in to use this extension");return}console.log("Pengguna sudah login. Token ditemukan:",e.token),chrome.tabs.onActivated.addListener(o=>{chrome.tabs.query({active:!0,currentWindow:!0},t=>{const r=t[0];console.log("Current Tab URL:",r.url),u(r)})}),chrome.tabs.onUpdated.addListener((o,t,r)=>{t.status==="complete"&&chrome.tabs.query({active:!0,currentWindow:!0},n=>{const s=n[0];console.log("Current Tab URL:",s.url),u(s)})}),chrome.runtime.onMessage.addListener(async(o,t,r)=>{if(console.log("Received Message:",o),o.type==="extractedText"){const n=o.text.split(" ").slice(0,100).join(" ");try{const s=await h(n);if(!s.ok)throw new Error(`HTTP error! Status: ${s.status}`);if(s==="negative"){const a="https://snailly-block.netlify.app/";chrome.tabs.update(t.tab.id,{url:a}),console.log(`Prediction: Dangerous. Redirected to ${a}`)}else console.log("Prediction: Safe.");r({success:!0,prediction})}catch(s){console.error("Error during prediction:",s.message),r({success:!1,error:s.message})}return!0}})})}const f=async e=>{chrome.storage.local.get(["user"],async o=>{console.log("User Data:",e);const t={childId:o.user.id,parentId:o.user.parentsId,url:e,web_title:e.split("//")[1].split("/")[0].split(".")[1],web_description:"",detail_url:""};try{const r=await fetch(p+"/log",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(t)})}catch(r){console.error("Error inserting history:",r.message)}})},u=async e=>{const o="https://snailly-block.netlify.app/";if(!e||!e.url){console.error("No current tab URL found.");return}try{const t=await fetch(p+"/classified-url/dangerous-website",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`}});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const n=(await t.json()).data.filter(i=>i.FINAL_label==="berbahaya").map(i=>i.url),s=i=>i.replace(/^https?:\/\/(www\.)?/,"").split("/")[0],a=n.map(s),g=e.url,c=s(g);if(console.log("Dangerous List:",a),console.log("Current Domain:",c),console.log("Check Link:",a.includes(c)),a.includes(c)){const i=await f(e.url);chrome.tabs.update(e.id,{url:o}),console.log(`Redirected from ${e.url} to ${o}`),console.log("Send History:",i)}else console.log(`URL not in dangerous list. Extracting text from: ${e.url}`),y(e.id)}catch(t){console.error("Error checking URL:",t.message)}},y=e=>{chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]})};
