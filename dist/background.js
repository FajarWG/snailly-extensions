chrome.runtime.onInstalled.addListener(()=>{console.log("Chrome Extension is installed!")});const u="https://snailly.unikom.ac.id";let l;chrome.storage.local.get(["token"],e=>{l=e.token});const d=async e=>{const r="https://www.vitejs.dev/";if(!e||!e.url){console.error("No current tab URL found.");return}try{const t=await fetch(u+"/classified-url/dangerous-website",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`}});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const o=(await t.json()).data.map(a=>a.url),s=a=>a.replace(/^https?:\/\/(www\.)?/,"").split("/")[0],n=o.map(s),h=e.url,i=s(h);console.log("Dangerous List:",n),console.log("Current Domain:",i),console.log("Check Link:",n.includes(i)),n.includes(i)?(chrome.tabs.update(e.id,{url:r}),console.log(`Redirected from ${e.url} to ${r}`)):(console.log(`URL not in dangerous list. Extracting text from: ${e.url}`),p(e.id))}catch(t){console.error("Error checking URL:",t.message)}},p=e=>{chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]})};chrome.tabs.onActivated.addListener(e=>{chrome.tabs.query({active:!0,currentWindow:!0},r=>{const t=r[0];console.log("Current Tab URL:",t.url),d(t)})});chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&chrome.tabs.query({active:!0,currentWindow:!0},c=>{const o=c[0];console.log("Current Tab URL:",o.url),d(o)})});chrome.runtime.onMessage.addListener(async(e,r,t)=>{if(e.type==="extractedText"){const c=e.text.split(" ").slice(0,100).join(" ");try{const o=await fetch(u+"/check-dangerous",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({text:c,url:r.tab.url})});if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);const s=await o.json();if(s.isDangerous){const n="https://www.vitejs.dev/";chrome.tabs.update(r.tab.id,{url:n}),console.log(`Prediction: Dangerous. Redirected to ${n}`)}else console.log("Prediction: Safe.");t({success:!0,prediction:s})}catch(o){console.error("Error during prediction:",o.message),t({success:!1,error:o.message})}return!0}});
